/**
 * Azoul • Workershild — One-file Server
 * - Unified dashboard (employee + manager) served at "/"
 * - API under "/api/*"
 * - In-memory store (swap to a DB in prod)
 *
 * Quickstart:
 *   npm init -y
 *   npm i express cors jsonwebtoken nanoid dayjs dotenv
 *   echo "JWT_SECRET=change_me" > .env   # optional (uses fallback if missing)
 *   node server.js
 *   http://localhost:4000
 */

const express = require('express');
const cors = require('cors');
const jwt = require('jsonwebtoken');
const { nanoid } = require('nanoid');
const dayjs = require('dayjs');
const path = require('path');
require('dotenv').config();

const app = express();
app.use(cors());
app.use(express.json());

// ---------- Demo Users (replace with real IdP later) ----------
const users = [
  { id: 'u_emp_1', email: 'employee1@demo.com', password: 'pass1234', role: 'employee' },
  { id: 'u_mgr_1', email: 'manager1@demo.com',  password: 'pass1234', role: 'manager'  },
];

// ---------- In-memory Reports ----------
/**
 * report = {
 *   id, createdAt, updatedAt,
 *   category, severity, message, anonymous, contact,
 *   receiptCode, status, assignee, managerNotes: [],
 *   firstResponseAt
 * }
 */
const reports = [];

const JWT_SECRET = process.env.JWT_SECRET || 'dev_only_secret_change_me';

// ---------- Helpers ----------
function signToken(user) {
  return jwt.sign(
    { sub: user.id, email: user.email, role: user.role },
    JWT_SECRET,
    { expiresIn: '8h' }
  );
}

function requireAuth(opts = {}) {
  return (req, res, next) => {
    const hdr = req.headers.authorization || '';
    const token = hdr.startsWith('Bearer ') ? hdr.slice(7) : null;
    if (!token) return res.status(401).json({ error: 'Missing token' });
    try {
      const payload = jwt.verify(token, JWT_SECRET);
      req.user = payload;
      if (opts.role && payload.role !== opts.role) {
        return res.status(403).json({ error: 'Forbidden' });
      }
      next();
    } catch (e) {
      return res.status(401).json({ error: 'Invalid token' });
    }
  };
}

// ---------- API ----------
app.post('/api/login', (req, res) => {
  try {
    const { email, password } = req.body || {};
    const user = users.find(u => u.email === email && u.password === password);
    if (!user) return res.status(401).json({ error: 'Invalid credentials' });
    return res.json({ token: signToken(user), role: user.role, email: user.email });
  } catch (e) {
    return res.status(500).json({ error: 'Login error' });
  }
});

app.post('/api/reports', requireAuth({ role: 'employee' }), (req, res) => {
  try {
    const { category, severity, message, anonymous = true, contact = '' } = req.body || {};
    if (!category || !severity || !message) {
      return res.status(400).json({ error: 'category, severity, message are required' });
    }
    const now = new Date().toISOString();
    const receiptCode = nanoid(10);
    const report = {
      id: nanoid(12),
      createdAt: now,
      updatedAt: now,
      category,
      severity,
      message,
      anonymous: !!anonymous,
      contact: anonymous ? '' : (contact || ''),
      receiptCode,
      status: 'new',        // new | in_progress | closed
      assignee: null,
      managerNotes: [],
      firstResponseAt: null
    };
    reports.push(report);
    return res.status(201).json({ id: report.id, receiptCode });
  } catch (e) {
    return res.status(500).json({ error: 'Create error' });
  }
});

app.get('/api/reports/track/:receiptCode', (req, res) => {
  try {
    const r = reports.find(rep => rep.receiptCode === req.params.receiptCode);
    if (!r) return res.status(404).json({ error: 'Not found' });
    return res.json({
      id: r.id,
      status: r.status,
      createdAt: r.createdAt,
      updatedAt: r.updatedAt,
      category: r.category,
      severity: r.severity,
    });
  } catch (e) {
    return res.status(500).json({ error: 'Track error' });
  }
});

app.get('/api/reports', requireAuth({ role: 'manager' }), (req, res) => {
  try {
    const { status, q, severity } = req.query;
    let data = reports.slice().sort((a, b) => (b.createdAt.localeCompare(a.createdAt)));
    if (status) data = data.filter(r => r.status === status);
    if (severity) data = data.filter(r => r.severity === severity);
    if (q) {
      const term = q.toLowerCase();
      data = data.filter(r =>
        (r.category || '').toLowerCase().includes(term) ||
        (r.message || '').toLowerCase().includes(term) ||
        (r.assignee || '').toLowerCase().includes(term)
      );
    }
    // Hide contact if anonymous
    const sanitized = data.map(r => ({
      ...r,
      contact: r.anonymous ? '' : r.contact
    }));
    return res.json(sanitized);
  } catch (e) {
    return res.status(500).json({ error: 'List error' });
  }
});

app.patch('/api/reports/:id', requireAuth({ role: 'manager' }), (req, res) => {
  try {
    const r = reports.find(rep => rep.id === req.params.id);
    if (!r) return res.status(404).json({ error: 'Not found' });

    const { status, assignee, managerNote } = req.body || {};
    if (status && !['new', 'in_progress', 'closed'].includes(status)) {
      return res.status(400).json({ error: 'Invalid status' });
    }

    if (typeof assignee === 'string') r.assignee = assignee.trim() || null;
    if (status) {
      if (!r.firstResponseAt && r.status === 'new' && status !== 'new') {
        r.firstResponseAt = new Date().toISOString();
      }
      r.status = status;
    }
    if (managerNote) {
      r.managerNotes.push({ at: new Date().toISOString(), text: managerNote });
    }
    r.updatedAt = new Date().toISOString();

    return res.json(r);
  } catch (e) {
    return res.status(500).json({ error: 'Update error' });
  }
});

app.get('/api/metrics', requireAuth({ role: 'manager' }), (req, res) => {
  try {
    const total = reports.length;
    const byStatus = ['new','in_progress','closed'].reduce((acc, s) => {
      acc[s] = reports.filter(r => r.status === s).length;
      return acc;
    }, {});

    // avg time to first response (in hours)
    const responded = reports.filter(r => r.firstResponseAt);
    const avgFirstResponseHrs = responded.length
      ? responded.reduce((sum, r) => {
          const diff = dayjs(r.firstResponseAt).diff(dayjs(r.createdAt), 'minute') / 60;
          return sum + diff;
        }, 0) / responded.length
      : 0;

    // last 7 days
    const last7 = reports.filter(r =>
      dayjs(r.createdAt).isAfter(dayjs().subtract(7, 'day'))
    ).length;

    res.json({
      total,
      byStatus,
      avgFirstResponseHrs: Number(avgFirstResponseHrs.toFixed(2)),
      last7Days: last7
    });
  } catch (e) {
    return res.status(500).json({ error: 'Metrics error' });
  }
});

// ---------- Unified Dashboard (HTML embedded) ----------
const DASHBOARD_HTML = `<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Workershild — Unified Dashboard</title>
<style>
  :root{
    --brand:#0a7abf; --ink:#0b1320; --muted:#64748b;
    --bg:#f6f8fb; --card:#fff; --line:#e5e7eb; --pill:#e2f2fb; --pillText:#055392;
  }
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{padding:22px 24px;background:#fff;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
  header h1{margin:0;font-size:1.25rem;letter-spacing:.2px}
  main{max-width:1120px;margin:28px auto;padding:0 16px 40px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:22px;margin:0 auto 18px}
  .row{display:flex;gap:14px;flex-wrap:wrap}
  label{display:block;font-weight:700;margin:10px 0 6px;font-size:1rem}
  input,select,textarea{
    width:100%;padding:14px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;
    font-size:1rem
  }
  textarea{resize:vertical}
  button{
    background:var(--brand);color:#fff;border:none;border-radius:10px;padding:12px 18px;cursor:pointer;
    font-size:1rem;min-width:110px
  }
  button:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:var(--muted);font-size:.95rem}
  .ok{color:#0a7a2c}.err{color:#b00020}
  .pill{background:var(--pill);color:var(--pillText);padding:6px 10px;border-radius:999px;font-size:.85rem}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{background:#f1f5f9;font-weight:800}
  .hide{display:none}
  .kpi{font-size:1.05rem}
  .topnote{display:flex;gap:8px;align-items:center}
  #loginCard{max-width:720px}
  #employeePanel .card, #managerPanel .card{max-width:1120px}
</style>
</head>
<body>
<header>
  <h1>Azoul • Workershild</h1>
  <div id="userBox" class="muted">Not signed in</div>
</header>

<main>

  <!-- Login -->
  <section class="card" id="loginCard">
    <h2 style="margin:0 0 6px 0;text-align:center">Sign in</h2>
    <div class="row" style="justify-content:center">
      <div style="flex:1;min-width:260px;max-width:320px">
        <label>Email</label>
        <input id="email" value="employee1@demo.com" />
      </div>
      <div style="flex:1;min-width:260px;max-width:320px">
        <label>Password</label>
        <input id="password" type="password" value="pass1234" />
      </div>
      <div style="align-self:flex-end">
        <button id="loginBtn">Login</button>
      </div>
    </div>
    <div id="loginMsg" class="muted" style="margin-top:10px;text-align:center"></div>
    <div class="muted" style="margin-top:10px;text-align:center">
      Demo accounts: <b>employee1@demo.com / pass1234</b> • <b>manager1@demo.com / pass1234</b>
    </div>
  </section>

  <!-- Employee Panel -->
  <section id="employeePanel" class="hide">
    <div class="card topnote" style="max-width:720px">
      <h3 style="margin:0">Employee</h3>
      <span class="pill">Anonymous by default</span>
    </div>

    <div class="card">
      <h3>Submit a concern</h3>
      <div class="row">
        <div style="flex:1;min-width:200px">
          <label>Category</label>
          <select id="e_category">
            <option>Safety</option><option>Harassment</option>
            <option>Scheduling</option><option>Pay/HR</option><option>Other</option>
          </select>
        </div>
        <div style="flex:1;min-width:200px">
          <label>Severity</label>
          <select id="e_severity">
            <option>low</option><option>medium</option><option>high</option>
          </select>
        </div>
      </div>
      <label>Message</label>
      <textarea id="e_message" rows="6" placeholder="Describe what happened..."></textarea>
      <div class="row" style="align-items:center">
        <div>
          <input type="checkbox" id="e_anonymous" checked />
          <label for="e_anonymous" style="display:inline;font-weight:600">Submit anonymously</label>
        </div>
        <div style="flex:1;min-width:260px">
          <label>Contact (optional if not anonymous)</label>
          <input id="e_contact" placeholder="phone/email (optional)" />
        </div>
        <div>
          <button id="e_submit">Send</button>
        </div>
      </div>
      <div id="e_submitMsg" class="muted" style="margin-top:8px"></div>
    </div>

    <div class="card" style="max-width:720px">
      <h3>Track a report</h3>
      <div class="row">
        <div style="flex:1;min-width:220px">
          <label>Receipt code</label>
          <input id="e_receipt" placeholder="e.g., 8Ksd2Yx3Qp" />
        </div>
        <div style="align-self:flex-end"><button id="e_track">Track</button></div>
      </div>
      <div id="e_trackBox" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- Manager Panel -->
  <section id="managerPanel" class="hide">
    <div class="card topnote" style="max-width:720px">
      <h3 style="margin:0">Manager</h3>
      <span class="pill">Audit‑ready & privacy‑safe</span>
    </div>

    <div class="card" id="m_metrics">
      <h3>Metrics (live)</h3>
      <div class="row">
        <div class="kpi"><b>Total:</b> <span id="k_total">0</span></div>
        <div class="kpi"><b>New:</b> <span id="k_new">0</span></div>
        <div class="kpi"><b>In progress:</b> <span id="k_inp">0</span></div>
        <div class="kpi"><b>Closed:</b> <span id="k_closed">0</span></div>
        <div class="kpi"><b>Avg first response (hrs):</b> <span id="k_avg">0</span></div>
        <div class="kpi"><b>Last 7 days:</b> <span id="k_last7">0</span></div>
      </div>
    </div>

    <div class="card">
      <h3>Queue</h3>
      <div class="row">
        <div style="flex:1;min-width:160px">
          <label>Status</label>
          <select id="f_status">
            <option value="">(any)</option><option>new</option><option>in_progress</option><option>closed</option>
          </select>
        </div>
        <div style="flex:1;min-width:160px">
          <label>Severity</label>
          <select id="f_sev">
            <option value="">(any)</option><option>low</option><option>medium</option><option>high</option>
          </select>
        </div>
        <div style="flex:2;min-width:220px">
          <label>Search</label>
          <input id="f_q" placeholder="category, message, assignee..." />
        </div>
        <div>
          <button id="applyBtn">Apply</button>
          <button id="clearBtn" style="background:#64748b">Clear</button>
        </div>
      </div>
    </div>

    <div class="card">
      <table id="tbl">
        <thead>
          <tr>
            <th>Created</th><th>Status</th><th>Category / Severity</th>
            <th>Message</th><th>Assignee</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

</main>

<script>
const API = location.origin + '/api';
let token = null;
let userRole = null;
function el(id){return document.getElementById(id)}
function show(id){el(id).classList.remove('hide')}
function hide(id){el(id).classList.add('hide')}

function setUser(email, role){
  userRole = role;
  el('userBox').innerHTML = \`Signed in as <b>\${email}</b> <span class="pill">\${role}</span>\`;
  hide('loginCard');
  if(role === 'employee'){ show('employeePanel'); hide('managerPanel'); }
  else if(role === 'manager'){ show('managerPanel'); hide('employeePanel'); refreshManager(); }
}

// Defensive JSON parse helper to avoid "Unexpected token '<'"
async function safeJson(resp){
  const text = await resp.text();
  try { return { ok:true, data: JSON.parse(text) }; }
  catch(e){
    return { ok:false, errorText: text.slice(0,200) || 'Non-JSON response' };
  }
}

el('loginBtn').onclick = async ()=>{
  el('loginBtn').disabled = true;
  el('loginMsg').textContent = 'Signing in...';
  try{
    const r = await fetch(API + '/login', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ email: el('email').value.trim(), password: el('password').value })
    });
    const parsed = await safeJson(r);
    if(!r.ok || !parsed.ok){
      const msg = parsed.ok ? (parsed.data.error || 'Login failed') :
        'Login failed: server returned non‑JSON (check server & /api prefix).';
      throw new Error(msg);
    }
    token = parsed.data.token;
    setUser(parsed.data.email, parsed.data.role);
  }catch(e){
    el('loginMsg').innerHTML = '<span class="err">'+e.message+'</span>';
  }finally{ el('loginBtn').disabled = false; }
};

// ============ EMPLOYEE ============
el('e_submit').onclick = async ()=>{
  if(!token || userRole!=='employee'){ alert('Please login as employee.'); return; }
  const anonymous = el('e_anonymous').checked;
  const payload = {
    category: el('e_category').value,
    severity: el('e_severity').value,
    message: el('e_message').value.trim(),
    anonymous,
    contact: anonymous ? '' : el('e_contact').value.trim()
  };
  el('e_submit').disabled = true;
  el('e_submitMsg').textContent = 'Submitting...';
  try{
    const r = await fetch(API + '/reports', {
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
      body: JSON.stringify(payload)
    });
    const parsed = await safeJson(r);
    if(!r.ok || !parsed.ok){
      throw new Error(parsed.ok ? (parsed.data.error || 'Submit failed') : 'Submit failed: non‑JSON response');
    }
    el('e_submitMsg').innerHTML = \`Received. Your <b>receipt code</b> is <span class="pill">\${parsed.data.receiptCode}</span>. Keep it to track status.\`;
    el('e_message').value=''; el('e_contact').value='';
  }catch(e){ el('e_submitMsg').innerHTML = '<span class="err">'+e.message+'</span>'; }
  finally{ el('e_submit').disabled = false; }
};

el('e_track').onclick = async ()=>{
  const rc = el('e_receipt').value.trim(); if(!rc) return;
  el('e_trackBox').textContent = 'Looking up...';
  try{
    const r = await fetch(API + '/reports/track/' + encodeURIComponent(rc));
    const parsed = await safeJson(r);
    if(!r.ok || !parsed.ok){ throw new Error(parsed.ok ? (parsed.data.error || 'Not found') : 'Track failed: non‑JSON'); }
    const data = parsed.data;
    el('e_trackBox').innerHTML =
      \`<div class="card"><div><b>ID:</b> \${data.id}</div>
       <div><b>Status:</b> <span class="pill">\${data.status}</span></div>
       <div class="muted">Created: \${new Date(data.createdAt).toLocaleString()}</div>
       <div class="muted">Updated: \${new Date(data.updatedAt).toLocaleString()}</div>
       <div class="muted">Category: \${data.category} • Severity: \${data.severity}</div></div>\`;
  }catch(e){ el('e_trackBox').innerHTML = '<span class="err">'+e.message+'</span>'; }
};

// ============ MANAGER ============
async function refreshManager(){ await Promise.all([loadMetrics(), loadQueue()]) }

async function loadMetrics(){
  const r = await fetch(API + '/metrics', { headers:{Authorization:'Bearer '+token}});
  const parsed = await safeJson(r);
  if(!r.ok || !parsed.ok){ throw new Error(parsed.ok ? (parsed.data.error||'metrics error') : 'metrics error: non‑JSON'); }
  const m = parsed.data;
  el('k_total').textContent = m.total; el('k_new').textContent = m.byStatus.new;
  el('k_inp').textContent   = m.byStatus.in_progress; el('k_closed').textContent = m.byStatus.closed;
  el('k_avg').textContent   = m.avgFirstResponseHrs;  el('k_last7').textContent = m.last7Days;
}

async function loadQueue(){
  const p = new URLSearchParams();
  if(el('f_status').value) p.set('status', el('f_status').value);
  if(el('f_sev').value)    p.set('severity', el('f_sev').value);
  if(el('f_q').value)      p.set('q', el('f_q').value.trim());
  const r = await fetch(API + '/reports?' + p.toString(), { headers:{Authorization:'Bearer '+token}});
  const parsed = await safeJson(r);
  if(!r.ok || !parsed.ok){ throw new Error(parsed.ok ? (parsed.data.error||'queue error') : 'queue error: non‑JSON'); }
  renderRows(parsed.data);
}

function renderRows(rows){
  const tbody = document.getElementById('tbody'); tbody.innerHTML = '';
  for(const r of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = \`
      <td>\${new Date(r.createdAt).toLocaleString()}</td>
      <td><span class="pill">\${r.status}</span></td>
      <td><div><b>\${r.category}</b></div><div>\${r.severity}</div></td>
      <td>\${escapeHtml(r.message).slice(0,280)}\${r.message.length>280?'…':''}</td>
      <td>\${r.assignee || '<span class="pill">unassigned</span>'}</td>
      <td>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <select data-act="status" data-id="\${r.id}">
            <option value="">set status…</option><option>new</option><option>in_progress</option><option>closed</option>
          </select>
          <input data-act="assignee" data-id="\${r.id}" placeholder="assignee" style="width:140px"/>
          <input data-act="note" data-id="\${r.id}" placeholder="add note…" style="width:180px"/>
          <button data-act="save" data-id="\${r.id}">Save</button>
        </div>
      </td>\`;
    tbody.appendChild(tr);
  }
  tbody.querySelectorAll('button[data-act="save"]').forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.dataset.id, row = btn.closest('tr');
      const statusSel = row.querySelector('select[data-act="status"]');
      const assignee  = row.querySelector('input[data-act="assignee"]').value.trim();
      const note      = row.querySelector('input[data-act="note"]').value.trim();
      const payload = {};
      if(statusSel.value) payload.status = statusSel.value;
      if(assignee) payload.assignee = assignee;
      if(note) payload.managerNote = note;
      btn.disabled = true;
      try{
        const r = await fetch(API + '/reports/' + id, {
          method:'PATCH',
          headers:{'Content-Type':'application/json', Authorization:'Bearer '+token},
          body: JSON.stringify(payload)
        });
        const parsed = await safeJson(r);
        if(!r.ok || !parsed.ok){ throw new Error(parsed.ok ? (parsed.data.error||'update error') : 'update error: non‑JSON'); }
        await refreshManager();
      }catch(e){ alert(e.message) } finally{ btn.disabled=false }
    }
  })
}

document.getElementById('applyBtn')?.addEventListener('click', loadQueue);
document.getElementById('clearBtn')?.addEventListener('click', ()=>{
  document.getElementById('f_status').value='';
  document.getElementById('f_sev').value='';
  document.getElementById('f_q').value='';
  loadQueue();
});

function escapeHtml(s){ return s.replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[m])) }
</script>
</body>
</html>`;

// Root route serves the dashboard
app.get('/', (req, res) => {
  res.setHeader('Content-Type', 'text/html; charset=utf-8');
  res.send(DASHBOARD_HTML);
});

// Fallback for any other non-API GET -> serve the app (handy on static hosts)
app.get(/^\/(?!api).*/, (req, res) => {
  res.setHeader('Content-Type', 'text/html; charset=utf-8');
  res.send(DASHBOARD_HTML);
});

// ---------- Start ----------
const PORT = process.env.PORT || 4000;
app.listen(PORT, () => {
  console.log(`Workershild (one-file) on http://localhost:${PORT}`);
  console.log(`Employee/Manager unified dashboard served at /`);
});
